---
title: Analyse
output:
  html_document: default
  pdf_document: default
---
```{r lecture données, echo = FALSE}
setwd("~/Desktop/Credits_recherche/CR_anoure")
anoure <- read.csv('donnees/anoure_nett.csv', header = T)
library(unmarked)
library(AICcmodavg)

#Données réponse
lisyl <- read.csv('donnees/lisyl.csv', header = T)

#Données occupation
occupation <- read.csv("donnees/donnees_occupation.csv", header = T)

#Données détection
qualite_lisyl <- read.csv('donnees/qualite_lisyl.csv', header = T)
perturb_lisyl <- read.csv('donnees/disturb_lisyl.csv', header = T)
heure_lisyl <- read.csv('donnees/heure_lisyl.csv', header = T)
jj_lisyl <- read.csv('donnees/jj_lisyl.csv', header =T)
```

# Grenouille des bois

## Variable réponse (Présence ou absence de la grenouille des bois)
Les données sont celles de 2022 seulement puisqu'il n'y a aucune observation en 2021 (les enregistrements ont commencé trop tard). Les observations de l'espèces ont eu lieu à 21h et à 1h. 

Nombre d'observations: 25

Nombre de sites où l'espèce est observée : 11

Dates de visites (quand l'espèce est active): 20 avril au 27 avril
```{r structure tableau lisyl}
str(lisyl)
```

## Variables de détection
* **Types de Perturbation** : Human, meteo ou none
* **Qualité de l'enregistrement** : Good, moderate ou bad
* **Heure de l'enregistrement**: 21h ou 1h
* **Date de l'enregistrement**: en jour julien

Difficile de joindre ensemble deux classes de données pour qualité de l'enregistrement. J'ai de loin beaucoup plus de moderate que de bad ou good
```{r table qualité}
table(anoure$RecordingQuality)
```


### Corrélation des variables
```{r correlation}
table(anoure$RecordingQuality, anoure$DisturbanceType)
```

```{r correlation heure date}
str(jj_lisyl)
str(heure_lisyl)
```
C'est certain que heure et date sont très corrélés. Est-ce que c'est juste de garder les deux dans les modèles?
Selon moi c'est pour ça qu'on voit ce warning quand je roule les poids AIC des modèles :
*Warning: 
Check model structure carefully as some models may be redundant*

## Variables d'occupation
* **Milieux humide** : Regroupement de Milieu humide, Tourbières et Marécage (à partir de la couche de milieu humide)
* **Eau libre** : Regroupement de Marais, Lac, Eau peu profonde et Eau (à partir de la couche de milieu humide et la couche d'utilisation du territoire)
* **Route** : Nombre de km de route total
* **Agriculture** : Regroupement de tous les types d'agriculture
* **Site** : Si le site est en lisière ou en forêt (donnée prise lors de la pause des enregistreurs) 

```{r structure tableau occ}
str(occupation)
```

### Corrélation des variables
```{r corrélation occupation}
plot(occupation)
```

## Création des modèles
Création du tableau de données pour le package unmarked
```{r}
lisyl.data <- unmarkedFrameOccu(y = lisyl, siteCovs = occupation, obsCovs = list(disturbance = perturb_lisyl, qualite = qualite_lisyl, heure = heure_lisyl, date = jj_lisyl))
summary(lisyl.data)
```

Modèles
```{r modèles}
#Détectabilité et occupation constante
m0 <- occu(~ 1 ~ 1, data = lisyl.data)

##Détectabilité varie selon la qualité de l'enregistrement et l'occupation varie selon...
mQH <- occu(~ qualite ~ Humide, data = lisyl.data)
mQE <- occu(~ qualite ~ Eau, data = lisyl.data)
mQR <- occu(~ qualite ~ Route, data = lisyl.data)
mQA <- occu(~ qualite ~ Agriculture, data = lisyl.data)
mQS <- occu(~ qualite ~ Site, data = lisyl.data)

##Détectabilité varie selon le type de perturbation et occupation varie selon ...
mPH <- occu(~ disturbance ~ Humide, data = lisyl.data)
mPE <- occu(~ disturbance ~ Eau, data = lisyl.data)
mPR <- occu(~ disturbance ~ Route, data = lisyl.data)
mPA <- occu(~ disturbance ~ Agriculture, data = lisyl.data)
mPS <- occu(~ disturbance ~ Site, data = lisyl.data)

##Détectabilité varie selon l'heure et occupation varie selon ...
mHH <- occu(~ heure ~ Humide, data = lisyl.data)
mHE <- occu(~ heure ~ Eau, data = lisyl.data)
mHR <- occu(~ heure ~ Route, data = lisyl.data)
mHA <- occu(~ heure ~ Agriculture, data = lisyl.data)
mHS <- occu(~ heure ~ Site, data = lisyl.data)

##Détectabilité varie selon les jours juliens et occupation varie selon ...
mDH <- occu(~ date ~ Humide, data = lisyl.data)
mDE <- occu(~ date ~ Eau, data = lisyl.data)
mDR <- occu(~ date ~ Route, data = lisyl.data)
mDA <- occu(~ date ~ Agriculture, data = lisyl.data)
mDS <- occu(~ date ~ Site, data = lisyl.data)
```

Tableau de tous les modèles avec le poid AIC
```{r, modèles candidats}
Cands <- list(m0, mQH, mQE, mQR, mQA, mQS, mPH, mPE, mPR, mPA, mPS, mHH, mHE, mHR, mHA, mHS, mDH, mDE, mDR, mDA, mDS)

##Donner les noms significaifs aux modèles
Model.names <- c("nul","psi(Milieux humides)p(Qualité)", "psi(Eau libre)p(Qualité)", "psi(Route)p(Qualité)", "psi(Agriculture)p(Qualité)", "psi(Site)p(Qualité)", "psi(Milieux humides)p(Perturb)", "psi(Eau libre)p(Perturb)", "psi(Route)p(Perturb)", "psi(Agriculture)p(Perturb)", "psi(Site)p(Perturb)", "psi(Milieux humides)p(Heure)", "psi(Eau libre)p(Heure)", "psi(Route)p(Heure)", "psi(Agriculture)p(Heure)", "psi(Site)p(Heure)", "psi(Milieux humides)p(Date)", "psi(Eau libre)p(Date)", "psi(Route)p(Date)", "psi(Agriculture)p(Date)", "psi(Site)p(Date)") 

##do model selection based on AICc 
aictab(cand.set = Cands,  modnames = Model.names)
```

### Vérification ajustement du modèle
Modèle avec le plus de poid est celui avec **Route** et **Date**
```{r, modèle avec plus de poid}
mDR
```
Code ajustement du modèle
```{r, ajustement du modèle, eval = FALSE}
ajust <- mb.gof.test(mDR, nsim = 5000, plot.hist=T)
save(ajust, file = "lisyl_ajust_gof.Rdata")
```
Le mb.gof.test produit vraiment beaucoup de ces warning: producedWarning: NAs. Est-ce que c'est grave?

```{r, résultat ajustement}
load("lisyl_ajust_gof.Rdata")
ajust
```
##### Refaire la sélection de modèles avec ajustement

Le warning de R dit que je dois garder 1 si le c.hat est inférieur à 1:

*Error in AICc.unmarkedFit(X[[i]], ...) : 
You should set 'c.hat' to 1 if < 1, but values << 1 might also indicate lack of fit*

Ce qui revient aux même aictab qu'avant


```{r}
########################################## 
##present results of survey type in plot
##create a data frame to make predictions 
##note that all variables on the parameter must appear here; mean of centered variable is 0 
pred.data <- data.frame(date = 0, heure = c(0,1))
##Type was coded 1 (minnow trap) or 0 (call ##survey)
##compute model-averaged predictions with ##modavgPred on probability scale
out.preds <- modavgPred(cand.set = Cands, modnames = Model.names, newdata = pred.data, parm.type = "detect", type = "response")
##compute model-averaged predictions with ##modavgPred on link scale
out.preds.logit <- modavgPred(cand.set = Cands, modnames = Model.names, newdata = pred.data, parm.type = "detect", type = "link")
##add predictions to data set to keep everything ##in the same place
pred.data$fit <- out.preds$mod.avg.pred 
pred.data$se.fit <- out.preds$uncond.se 
##compute 95% CI on logit scale, then back ##transform; these asymmetric CI’s have better ##properties
pred.data$low95 <- plogis(out.preds.logit$mod.avg.pred - 1.96 * out.preds.logit$uncond.se) 
pred.data$upp95 <- plogis( out.preds.logit$mod.avg.pred + 1.96 * out.preds.logit$uncond.se)
##compare against predictions for a single model ##this is ONLY appropriate IF top model has most ##of the weight (w_i > 0.90); this not the case ##here
predict(m2, newdata = pred.data, type = "det", backTransform = TRUE)
########################################## 
##create plot and save it directly in a file 
##you will not see the plot in R, as it will be stored in the file you specify; the file will be stored at the location specified by setwd( ) above; see ?Devices for all the file types available (pdf, jpeg, tiff, etc...)
png(file = "lisyl_type.png", width = 3600, height = 3600, res = 675)
##remove white space above plot
par(mar = c(5, 4, 2, 2) + 0.1)
##plot without x axis, we’ll add later 
plot(pred.data$fit ~ c(0.25, 0.75),
ylab = "Detection probability", xlab = "Survey type", xaxt = "n", ylim = range(c(pred.data$low95, pred.data$upp95)), 
#to avoid truncating confidence limits on plot 
xlim = c(0, 1), cex.lab = 1.2,
#make axis labels 1.2 times larger than default 
cex.axis = 1.2) 
#make tick labels 1.2 times #larger than default
##add x axis
axis(side = 1, labels = c("Perturbation", "Qualite"), at = c(0.25, 0.75), cex.axis = 1.2)
##add error bars; segments( ) draws lines from ##point (x0, y0) to point (x1, y1)
segments(x0 = c(0.25, 0.75), x1 = c(0.25, 0.75), y0 = pred.data$low95, y1 = pred.data$upp95)

```



