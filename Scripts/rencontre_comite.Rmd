---
title: Analyse crédits de recherche
output:
  html_document: default
  pdf_document: default
---
```{r lecture données, echo = FALSE}
setwd("~/Desktop/Credits_recherche/CR_anoure")
anoure <- read.csv('donnees/anoure_nett.csv', header = T)
anoure_licat <- read.csv('donnees/anoure_licat.csv', header = T)
library(unmarked)
library(AICcmodavg)

#Données réponse
licat <- read.csv('donnees/licat.csv', header = T)
lisyl <- read.csv('donnees/lisyl.csv', header = T)

#Données occupation
occupation_lisyl <- read.csv("donnees/donnees_occupation.csv", header = T)
occupation_licat <- read.csv("donnees/donnees_occupation_licat.csv", header = T)

#Données détection lisyl
qualite_lisyl <- read.csv('donnees/qualite_lisyl.csv', header = T)
perturb_lisyl <- read.csv('donnees/disturb_lisyl.csv', header = T)
heure_lisyl <- read.csv('donnees/heure_lisyl.csv', header = T)
jj_lisyl <- read.csv('donnees/jj_lisyl.csv', header =T)

#Données détection licat
qualite_licat <- read.csv('donnees/qualite_licat.csv', header = T)
perturb_licat <- read.csv('donnees/disturb_licat.csv', header = T)
annee_licat <- read.csv('donnees/annee_licat.csv', header = T)
jj_licat <- read.csv('donnees/jj_licat.csv', header =T)

#Transformation annee en facteur
annee_licat$V1<-as.factor(annee_licat$V1)
annee_licat$V2<-as.factor(annee_licat$V2)
annee_licat$V3<-as.factor(annee_licat$V3)
annee_licat$V4<-as.factor(annee_licat$V4)
annee_licat$V5<-as.factor(annee_licat$V5)
annee_licat$V6<-as.factor(annee_licat$V6)
annee_licat$V7<-as.factor(annee_licat$V7)
annee_licat$V8<-factor(annee_licat$V8, levels = c("2021", "2022"))
occupation_licat$annee <- as.factor(occupation_licat$annee)
annee_licat$V9<-factor(annee_licat$V9, levels = c("2021", "2022"))


```

# Rappel du projet

## Méthode
Des enregistreurs ont été placés sur 26 étangs de reproductions d'anoures et ils ont été opérationnels du 5 mai 2021 au 13 juillet 2021 et du 19 avril 2022 au 27 juillet 2022. Des enregistrements de 3 minutes ont eu lieux à 15h, à 21h et à 1h à chaque semaine. Chaque enregistrement a été écouté et pour chacun j'ai noté le site, la date, l’heure, la qualité de l'enregistrement, la principale perturbation sonore ainsi que la présence ou absence de chaque espèce.

Autour de chaque site, une zone tampon d'un rayon de 300 m a été délimité puisque c'est la moyenne de distance parcourue par les anoures. Sur QGIS, j'ai utilisé les couches gouvernementales d'utilisation du territoire, de réseu routier et de milieux humides potentiels pour obtenir les superficies de recouvrement des différents types de milieux.

## Objectifs
* Évaluer les relations entre les variables environnementales et la probabilité d'occupation des espèces d’anoures dans différents étangs de reproduction. 

* Déterminer quelle variable ou quel ensemble de variables environnementales influence le plus la probabilité d'occupation de chaque espèce d’anoure

## Hypothèses
Je n'ai pas pus aller sur le terrain finalement et peu de variables pouvaient être utilisées pour les différents modèles alors j'ai du changer mes hypothèses. De plus, j'ai du utiliser la présence au lieu de l'abondance dans les modèles statistiques. Voici mes hypothèses modifiées compte tenu des restrictions :

* 1.1 La présence de milieux humides en périphérie des étangs de reproduction augmente la présence d'anoures

* 1.2 Les milieux humides avec de l'eau permanente favorisent la présence d’anoures avec un long stade larvaire puisque les larves de certaines espèces doivent rester jusqu’à deux saisons dans l’eau avant la métamorphose. 

* 1.3 La présence de site agricoles en périphérie des étangs de reproduction réduit la présence d'anoures

* 1.4 la présence de routes en périphérie des étangs réduit l’abondance d’anoures puisqu’elles sont une cause de mortalité importante 

Hypothèses de détection???

# Analyse statistique 
L'analyse statistique est faite à partir du package `unmarked`

Les modèles prennent en compte la *probabilité de détection* qui varie selon les conditions de l'échantillonnage, et la *probabilité d'occupation* qui varie selon les caractéristiques du site et du paysage.

## Variable réponse (présence ou absence)
Les deux seules espèces ayant un nombre d'observation suffisant et n'étaient pas présentes dans tous les sites sont la *grenouille des bois* et le *ouaouaron*. Ce sont donc les deux espèces utilisées dans l'analyse

### Grenouille des bois 
Les données sont celles de 2022 seulement puisqu'il n'y a aucune observation en 2021 (les enregistrements ont commencé trop tard). Les observations de l'espèce ont eu lieu à 21h et à 1h. 

Nombre d'observations: 25

Nombre de sites où l'espèce est observée : 11

Dates de visites (quand l'espèce est active): 20 avril au 27 avril
```{r structure tableau lisyl}
str(lisyl)
```

### Ouaouaron 
Les observations sont à 1 h en 2021 et 2022. Les visites à 15 h et 21 h n'ont pas été utilisé puisqu'il n'y avait qu'une à trois observations

Nombre d'observations 2021: 43

Nombre d'observations 2022: 32

Nombre de sites où l'espèce est observée 2021: 14

Nombre de sites où l'espèce est observée 2022: 15

Dates de visites (quand l'espèce est active) 2021: 27 mai au 7 juillet

Dates de visites (quand l'espèce est active) 2022: 25 mai au 20 juillet
```{r structure tableau licat}
str(licat)
```

## Variables de détection
* **Types de Perturbation** : Human, meteo ou none
* **Qualité de l'enregistrement** : Good, moderate ou bad
* **Heure de l'enregistrement** (pour la grenouilles des bois seulement): 21h ou 1h
* **Année de l'enregistrement** (pour le ouaouaron seulement) : 2021 ou 2022
* **Jour de l'enregistrement**: en jour julien

Exemple : Tableau des jours juliens pour la grenouille des bois
```{r correlation heure jour, lisyl}
str(jj_lisyl)
```

Exemple : Tableau de l'année (transformé en facteur) pour le ouaouaron
```{r correlation annee jour licat}
str(annee_licat)
```

### Corrélation des variables
```{r correl annee jour}
par(mfrow=c(2,2))
boxplot(anoure_licat$jour_julien ~ anoure_licat$Year, xlab = 'Année (ouaouaron)', ylab = "Jour en jours juliens")
boxplot(anoure_licat$RecordingQuality ~ anoure_licat$Year, xlab = 'Année (ouaouaron)', ylab = "Qualité de l'enregistrement")
boxplot(anoure_licat$DisturbanceType ~ anoure_licat$Year, xlab = 'Année (ouaouaron)', ylab = "Type de perturbation")
```

La qualité d'enregistrement et le type de perturbation ne varient pas avec l'année alors on peu faire les modèles jumelant ces variables

Le jour varie entre les années alors il ne faut pas les laisser ensemble dans les modèles

```{r correlation}
table(anoure$RecordingQuality, anoure$DisturbanceType)
```

## Variables d'occupation
Obtenues à partir de couches qgis

* **Milieux humide** : Superficie (m2) des milieux humides de type Milieu humide, Tourbières et Marécage
* **Eau libre** : Superficie (m2) des milieux humides de type Marais, Lac, Eau peu profonde et Eau
* **Route** : Nombre de km de route total
* **Agriculture** : Superficie (m2) de tous les types d'agriculture
* **Site** : Facteur de lisière de forêt ou en forêt

* **Annéee** : Pour le ouaouaron seulement puisque les données sont sur deux années. Facteur entre 2021 et 2022

Les superficies ont été transformées en pourcentage de recouvrement puis standardisées avec la fonction `scale()`
```{r standardiser occupation, include =F}
occupation_licat$Route <- scale(occupation_licat$Route)
occupation_licat$Agriculture <- scale(occupation_licat$Agriculture)
occupation_licat$Eau <- scale(occupation_licat$Eau)
occupation_licat$Humide <- scale(occupation_licat$Humide)
occupation_licat$Site <- as.factor(occupation_licat$Site)

occupation_lisyl$Route <- scale(occupation_lisyl$Route)
occupation_lisyl$Agriculture <- scale(occupation_lisyl$Agriculture)
occupation_lisyl$Eau <- scale(occupation_lisyl$Eau)
occupation_lisyl$Humide <- scale(occupation_lisyl$Humide)
occupation_lisyl$Site <- as.factor(occupation_lisyl$Site)
```

```{r structure occupation}
str(occupation_lisyl)
str(occupation_licat)
```

### Corrélation des variables
```{r corrélation occupation}
plot(occupation_lisyl)
```

## Création des modèles pour la grenouille des bois
Création de la base de données pour le package `unmarked`
```{r, data lisyl, warning = F}
lisyl.data <- unmarkedFrameOccu(y = lisyl, siteCovs = occupation_lisyl, obsCovs = list(disturbance = perturb_lisyl, qualite = qualite_lisyl, heure = heure_lisyl, jour = jj_lisyl))
summary(lisyl.data)
```

#### Modèles
```{r modèles lisyl}
# Détectabilité et occupation constante (modèle nul)
mb0 <- occu(~ 1 ~ 1, data = lisyl.data)

# Détectabilité varie selon la qualité de l'enregistrement et l'occupation varie selon...
# Le pourcentage de recouvrement de milieux humides
mbQH <- occu(~ qualite ~ Humide, data = lisyl.data)
# Le pourcentage de recouvrement de milieux d'eau libre
mbQE <- occu(~ qualite ~ Eau, data = lisyl.data)
# Le nombre de km de routes
mbQR <- occu(~ qualite ~ Route, data = lisyl.data)
# Le pourcentage de recouvrement de terres agricoles
mbQA <- occu(~ qualite ~ Agriculture, data = lisyl.data)
# Le positionnement du site (en lisière ou en forêt)
mbQS <- occu(~ qualite ~ Site, data = lisyl.data)

# Détectabilité varie selon le type de perturbation et occupation varie selon ...
mbPH <- occu(~ disturbance ~ Humide, data = lisyl.data)
mbPE <- occu(~ disturbance ~ Eau, data = lisyl.data)
mbPR <- occu(~ disturbance ~ Route, data = lisyl.data)
mbPA <- occu(~ disturbance ~ Agriculture, data = lisyl.data)
mbPS <- occu(~ disturbance ~ Site, data = lisyl.data)

# Détectabilité varie selon l'heure et occupation varie selon ...
mbHH <- occu(~ heure ~ Humide, data = lisyl.data)
mbHE <- occu(~ heure ~ Eau, data = lisyl.data)
mbHR <- occu(~ heure ~ Route, data = lisyl.data)
mbHA <- occu(~ heure ~ Agriculture, data = lisyl.data)
mbHS <- occu(~ heure ~ Site, data = lisyl.data)

# Détectabilité varie selon les jours juliens et occupation varie selon ...
mbDH <- occu(~ jour ~ Humide, data = lisyl.data)
mbDE <- occu(~ jour ~ Eau, data = lisyl.data)
mbDR <- occu(~ jour ~ Route, data = lisyl.data)
mbDA <- occu(~ jour ~ Agriculture, data = lisyl.data)
mbDS <- occu(~ jour ~ Site, data = lisyl.data)
```

Tableau de tous les modèles avec le poid AIC
```{r, modèles candidats lisyl}
# Liste des modèles
Cands <- list(mb0, mbQH, mbQE, mbQR, mbQA, mbQS, mbPH, mbPE, mbPR, mbPA, mbPS, mbHH, mbHE, mbHR, mbHA, mbHS, mbDH, mbDE, mbDR, mbDA, mbDS)

# Noms des modèles
Model.names <- c("nul","psi(Milieux humides)p(Qualité)", "psi(Eau libre)p(Qualité)", "psi(Route)p(Qualité)", "psi(Agriculture)p(Qualité)", "psi(Site)p(Qualité)", "psi(Milieux humides)p(Perturb)", "psi(Eau libre)p(Perturb)", "psi(Route)p(Perturb)", "psi(Agriculture)p(Perturb)", "psi(Site)p(Perturb)", "psi(Milieux humides)p(Heure)", "psi(Eau libre)p(Heure)", "psi(Route)p(Heure)", "psi(Agriculture)p(Heure)", "psi(Site)p(Heure)", "psi(Milieux humides)p(Jour)", "psi(Eau libre)p(Jour)", "psi(Route)p(Jour)", "psi(Agriculture)p(Jour)", "psi(Site)p(Jour)") 

# Sélection des modèles basées sur AICc
aictab(cand.set = Cands,  modnames = Model.names)
```

L'AICc dépend de la vraisemblance (négative) et du nombre de paramètres (positivement). Il permet donc de trouver le/les modèle qui explique le mieux la variation des données. Un petit AIC est donc préféré.

Delta AICc est la différence entre le AICc du modèle et celui du meilleur modèle. On veut donc un DeltaAICc le plus petit (<=2)

Les modèles qui ont le plus de poids (AICcWt) (qui expliquent une plus grande proportion de la variation dans les variables réponses) sont ceux avec **Route** et **Jour**, suivi de **Eau libre** et **Jour**

```{r, modèles ave plus de poids lisyl}
mbDR
mbDE
```
La détection est influencé positivement par le jour de l'enregistrement (pente = 0,267 et p-value = 0.0465).

La relation entre l'occupation et la route ou l'eau libre n'est pas significative.

### Vérification ajustement du modèle

Code ajustement du modèle
```{r, ajustement du modèle lisyl, eval = FALSE}
ajust <- mb.gof.test(mbDR, nsim = 5000, plot.hist=T)
save(ajust, file = "lisyl_ajust_gof.Rdata")
```

```{r, résultat ajustement lisyl}
load("lisyl_ajust_gof.Rdata")
ajust
```
Pas besoin de réajuster le modèle puisque le c-hat (0.79) est < à 1

## Création des modèles pour le ouaouaron
Création de la base de données pour le package `unmarked`
```{r data licat, warning = F}
licat.data <- unmarkedFrameOccu(y = licat, siteCovs = occupation_licat, obsCovs = list(disturbance = perturb_licat, qualite = qualite_licat, annee = annee_licat, jour = jj_licat))
summary(licat.data)
```

#### Modèles
```{r modèles licat}
# Détectabilité et occupation constante
mo0 <- occu(~ annee ~ annee, data = licat.data)

# Détectabilité varie selon la qualité de l'enregistrement et l'occupation varie selon...
moQH <- occu(~ qualite + annee ~ Humide + annee, data = licat.data)
moQE <- occu(~ qualite + annee ~ Eau + annee, data = licat.data)
moQR <- occu(~ qualite + annee ~ Route + annee, data = licat.data)
moQA <- occu(~ qualite + annee ~ Agriculture + annee, data = licat.data)
moQS <- occu(~ qualite + annee ~ Site + annee, data = licat.data)

# Détectabilité varie selon le type de perturbation et occupation varie selon ...
moPH <- occu(~ disturbance + annee ~ Humide + annee, data = licat.data)
moPE <- occu(~ disturbance + annee ~ Eau + annee, data = licat.data)
moPR <- occu(~ disturbance + annee ~ Route + annee, data = licat.data)
moPA <- occu(~ disturbance + annee ~ Agriculture + annee, data = licat.data)
moPS <- occu(~ disturbance + annee ~ Site + annee, data = licat.data)

# Détectabilité varie selon l'année et occupation varie selon ...
moAH <- occu(~ annee ~ Humide + annee, data = licat.data)
moAE <- occu(~ annee ~ Eau + annee, data = licat.data)
moAR <- occu(~ annee ~ Route + annee, data = licat.data)
moAA <- occu(~ annee ~ Agriculture + annee, data = licat.data)
moAS <- occu(~ annee ~ Site + annee, data = licat.data)

# Détectabilité varie selon les jours juliens et occupation varie selon ...
moDH <- occu(~ jour ~ Humide + annee, data = licat.data)
moDE <- occu(~ jour ~ Eau + annee, data = licat.data)
moDR <- occu(~ jour ~ Route + annee, data = licat.data)
moDA <- occu(~ jour ~ Agriculture + annee, data = licat.data)
moDS <- occu(~ jour ~ Site + annee, data = licat.data)
```
Ici, l'année est ajouté à tous les modèles dans la détection et dans l'occupation puisque les données sont prisent sur deux années. Cependant, elle n'a pas été rajoutée aux modèles ou la détection varie avec le jour puisque les jours juliens variaient d'une année à l'autre.

Tableau de tous les modèles avec le poid AIC
```{r, modèles candidats licat}
# Liste des modèles
Cands <- list(mo0, moQH, moQE, moQR, moQA, moQS, moPH, moPE, moPR, moPA, moPS, moAH, moAE, moAR, moAA, moAS, moDH, moDE, moDR, moDA, moDS)

# Noms des modèles
Model.names <- c("nul","psi(Milieux humides)p(Qualité)", "psi(Eau libre)p(Qualité)", "psi(Route)p(Qualité)", "psi(Agriculture)p(Qualité)", "psi(Site)p(Qualité)", "psi(Milieux humides)p(Perturb)", "psi(Eau libre)p(Perturb)", "psi(Route)p(Perturb)", "psi(Agriculture)p(Perturb)", "psi(Site)p(Perturb)", "psi(Milieux humides)p(Année)", "psi(Eau libre)p(Année)", "psi(Route)p(Année)", "psi(Agriculture)p(Année)", "psi(Site)p(Année)", "psi(Milieux humides)p(Jour)", "psi(Eau libre)p(Jour)", "psi(Route)p(Jour)", "psi(Agriculture)p(Jour)", "psi(Site)p(Jour)") 

# Sélection de modèles basées sur AICc
aictab(cand.set = Cands,  modnames = Model.names)
```

Modèles avec tout le poid sont celui avec **Route** et **Qualité** et celui avec **Site** et **Qualité**
```{r, modèle avec plus de poid licat}
moQA
moQH
```
INTERPRÉTER 

### Vérification ajustement du modèle

Code ajustement du modèle
```{r, ajustement du modèle licat, eval = FALSE}
ajust <- mb.gof.test(moQA, nsim = 5000, plot.hist=T)
save(ajust, file = "licat_ajust_gof.Rdata")
```

```{r, résultat ajustement licat}
load("licat_ajust_gof.Rdata")
ajust
```
Pas besoin de réajuster le modèle puisque le c-hat (0.43) est < à 1

### Inférence multimodèles
Avec l'utilisation du package `AICcmodavg`

Important parce que les meilleurs modèles n'ont pas tout le poids AIC. Permet de combiner les différents modèles selon leur poids AIC.

Les variables ayant une influence significative sur la détection ou l'année : **Humide** **annee2022** et peut-être? **Agriculture**
```{r inférence multimodèle avec SHRINK}
modavgShrink(cand.set = Cands, modnames = Model.names, parm = "Humide", parm.type = "psi")
modavgShrink(cand.set = Cands, modnames = Model.names, parm = "annee2022", parm.type = "detect")
modavgShrink(cand.set = Cands, modnames = Model.names, parm = "Agriculture", parm.type = "psi")
```
Si je comprends bien, les pentes seraient ainsi plutôt de 

* 0,25 entre Milieux humides et occupation
* -1.35 entre annee2022 et détection
* 0.74 entre Agriculture et occupation

```{r graphique}
## Data frame pour faire les prédictions
extractX(cand.set = Cands, modnames = Model.names, parm.type = "psi")
pred.data <- data.frame(annee = factor("2021",
                                      levels = levels(occupation_licat$annee)),
Eau = c(0,0),
Humide = seq(-2.28, 1.05, length.out = 40),
Route = c(0, 0),
Agriculture = c(0, 0),
Site = factor("lisiere",
              levels = levels(occupation_licat$Site))
)

out.preds <- modavgPred(cand.set = Cands, modnames = Model.names, newdata = pred.data, parm.type = "psi", type = "response")
##add predictions to data set to keep everything ##in the same place
pred.data$fit <- out.preds$mod.avg.pred 
pred.data$se.fit <- out.preds$uncond.se 
##compute 95% CI on logit scale, then back ##transform; these asymmetric CI’s have better ##properties
pred.data$low95 <- out.preds$lower.CL 
pred.data$upp95 <- out.preds$upper.CL

pred.data$xvals <- seq(-2.28, 1.05, length.out = 40)
plot(fit ~ xvals,
data = pred.data,
ylim = range(low95, upp95),
xlab = "Proportion de recouvrement de milieux humides (standardisé)",
ylab = "Présence de ouaouarons",
cex.axis = 1.2,
cex.lab = 1.2)

segments(x0 = pred.data$xvals, x1 = pred.data$xvals, y0 = pred.data$low95, pred.data$upp95)
```

# Questions

Ajouter des hypothèses de détection?